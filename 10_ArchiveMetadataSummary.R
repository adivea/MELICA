# --- Checking Aarhus CIty Archive Digitisation progress


# Libraries
library(tidyverse)
library(googlesheets4)
install.packages("fable")
library(tsibbledata)
library(fable)
library(lubridate)

# Load metadata of scanned documents 2024-08-21
gs4_deauth()
metadata <- read_sheet("https://docs.google.com/spreadsheets/d/1TQfZCGlK3fyAcLzKpaFvN2Un3O1dH-twi2qwLXyyFSA/edit?pli=1&gid=0#gid=0", 
                       range = "CDdata", 
                       col_types = "ccDDccccccccccccc") 
glimpse(metadata)

# Clean column names

metadata <- metadata %>% 
  rename(ID = ScanningsID, Startdate = `Dato fra (åååå-mm-dd)`, Enddate = `Dato til (åååå-mm-dd)`, Contenttype2 = `Indholdstype 2`,
         Contenttype3 =  `Indholdstype 3`, Contenttype4 = `Indholdstype 4`, Handwriting = `Indeholder håndskrift`, Visuals = `Mulige problemer med OCR`) %>% 
  select(ID, Startdate, Enddate, Beskrivelsesnoter, Contenttype2, Contenttype3, Contenttype4, Kommentar, Handwriting, Visuals, EnhedsID )

table(metadata$Startdate)


# ---Classification of documents by content (Map, Visuals, Text)

metadata <- metadata %>%
  mutate(
    Type = case_when(
      str_detect(Contenttype2, regex("kort", ignore_case = TRUE)) |
        str_detect(Contenttype3, regex("kort", ignore_case = TRUE)) |
        str_detect(Contenttype4, regex("kort", ignore_case = TRUE)) ~ "map",
      str_detect(Contenttype2, regex("billed", ignore_case = TRUE)) |
        str_detect(Contenttype3, regex("billed", ignore_case = TRUE)) |
        str_detect(Contenttype4, regex("billed", ignore_case = TRUE)) ~ "plan",
      Visuals == "x" ~ "graphic",
      TRUE ~ "text"
    )
  )


metadata %>% 
  group_by(Type) %>% 
  summarize(sum = n(),
            percent = round(sum / nrow(m_ts) *100, 1))

# ------- Start with time

# Convert the tibble into a temporal tsibble (lose 20 records without date)
m_ts <- as_tsibble(metadata %>% filter(!is.na(Startdate)), key = ID, index = Startdate)

# Aggregate publication dates over monthly periods
df_monthly <- m_ts %>% 
  tsibble::index_by(year_month = ~ yearmonth(.)) %>% # monthly aggregates
  summarise(count = n()) 

# Aggregate publication dates over monthly periods with type
publ_monthly <- m_ts %>% 
  tsibble::index_by(year_month = ~ yearmonth(.)) %>% # monthly aggregates
  group_by(Type) %>% 
  summarise(count = n()) 

# Aggregate publication dates over monthly periods with type, and 'date' type for ggplot
docs_monthly <- publ_monthly %>%
  as_tibble() %>% 
  mutate(year_month = as.Date(year_month))

# ---- Initial visualisation test - all documents, typed docs, and a grid

autoplot(df_monthly, count) +
  labs(
    title = "Civil Defence Commission document output per Month",
    x = "Year-Month",
    y = "Number of archived documents"
  ) +
  theme_minimal()
ggsave("figures/archiveddocs_20240820.png")


# Aggregate by group publication dates over monthly periods

autoplot(publ_monthly, count) +
  labs(
    title = "Civil Defence Commission document output per Month",
    x = "Year-Month",
    y = "Number of archived documents"
  ) +
  guides(colour = guide_legend(title = "Document type")) +
  theme_minimal() +
  theme(
    legend.position = c(0.9, 0.8),
    legend.background = element_rect(fill = "white", color = "black"),  # Optional: Add a background to the legend for better visibility
    legend.title = element_text(size = 10),  # Adjust legend title size
    legend.text = element_text(size = 8)  # Adjust legend text size
  )# Adjust these values to move the legend
  
ggsave("figures/archiveddocsType_20240820.png")


# Types in a grid per month

ggplot(docs_monthly, aes(x = year_month, y = count, color = Type)) +
  geom_line() +
  facet_grid( Type ~ .) +
  theme_minimal()


#  ----   Combine visual overview into two
install.packages("patchwork")
library(patchwork)

plain <- autoplot(df_monthly, count) +
  labs(
    title = "Civil Defence Commission document output per Month",
    x = NULL,
    y = "Archived documents",
  ) +
  theme_minimal()

typed <- autoplot(publ_monthly, count) +
  labs(
    x = NULL,
    y = "Documents by type"
  ) +
  guides(colour = guide_legend(title = "Document type")) +
  theme_minimal() +
  theme(
    legend.position = c(0.9, 0.6),
    legend.background = element_rect(fill = "white", color = "black"),  # Optional: Add a background to the legend for better visibility
    legend.title = element_text(size = 10),  # Adjust legend title size
    legend.text = element_text(size = 8)  # Adjust legend text size
  )# Adjust these values to move the legend

combined_plot <- plain / typed
combined_plot

ggsave("figures/archiveddocsaggr_20240820.png")



######  ------------------- Plotting with zoom facet

library(ggforce)


# Plot the data

# 1950s
p50 <- ggplot(docs_monthly, aes(x = year_month, y = count, color = Type)) +
  geom_line() +
  facet_zoom(x = year_month >as.Date("1949-01-30") & year_month < as.Date("1960-01-31"))+
  
  labs(
    title = "Aarhus CDC output per month",
    x = "Year-Month",
    y = "Number of shelter-related documents"
  ) +
  theme_light() +
  scale_x_date(date_breaks = "5 years", date_labels = "%Y") 


# 1960s
p60 <- ggplot(docs_monthly, aes(x = year_month, y = count, color = Type)) +
  geom_line() +
  facet_zoom(x = year_month >as.Date("1959-01-30") & year_month < as.Date("1970-01-31"))+
  
  labs(
    title = "Aarhus CDC output per month",
    x = "Year-Month",
    y = "Number of shelter-related documents"
  ) +
  theme_light() +
  scale_x_date(date_breaks = "5 years", date_labels = "%Y") 

# 1970s
p70 <- ggplot(docs_monthly, aes(x = year_month, y = count, color = Type)) +
  geom_line() +
  facet_zoom(x = year_month >as.Date("1969-01-30") & year_month < as.Date("1980-01-31"))+
  
  labs(
    title = "Aarhus CDC output per month",
    x = "Year-Month",
    y = "Number of shelter-related documents"
  ) +
  theme_light() +
  scale_x_date(date_breaks = "5 years", date_labels = "%Y") 

# 1980s
p80 <- ggplot(docs_monthly, aes(x = year_month, y = count, color = Type)) +
  geom_line() +
  facet_zoom(x = year_month >as.Date("1979-01-30") & year_month < as.Date("1990-01-31"))+
  
  labs(
    title = "Aarhus CDC output per month",
    x = "Year-Month",
    y = "Number of shelter-related documents"
  ) +
  theme_light() +
  scale_x_date(date_breaks = "5 years", date_labels = "%Y") 

p50
ggsave("figures/archiveddocs1950_20240820.png")
p60
ggsave("figures/archiveddocs1960_20240820.png")
p70
ggsave("figures/archiveddocs1970_20240820.png")
p80
ggsave("figures/archiveddocs1980_20240820.png")
